{% extends 'core/base.html' %}
{% load bootstrap4 %}


{% block conteudo %}
    <!-- Breadcrumbs-->
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'core:index'%}">Início</a>
        </li>
        <li class="breadcrumb-item ">
            <a href="{%url 'core:locacao-listar'%}">Locações</a>
        </li>
        <li class="breadcrumb-item"><a href="{%url 'core:locacao-realizar'%}">Novo</a></li>
        <li class="breadcrumb-item active">{{ locacao.cliente }}</li>
    </ol>
    
    {% bootstrap_messages %}
    
    <div class="progress mb-3">
        <div class="progress-bar bg-info" role="progressbar" aria-valuenow="66" aria-valuemin="0" aria-valuemax="100" style="width: 66%">66%</div>
    </div>
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-table"></i>
                Itens da Locação
        </div>   
        <div class="card-body">
            <div class="table-responsive">  
                <button type="button" class="btn btn-primary js-add-item mb-3 float-right" data-url="{% url 'core:ajax-item-add' %}">
                    Adicionar Item
                </button>                
                <table id="item_locacao_tb" class="table table-striped table-bordered" cellspacing="0">
                    <thead class="text-center">
                        <tr>
                            <th scope="col">Filme</th>
                            <th scope="col">Data Prevista de Devolução</th>
                            <th scope="col">Valor</th>
                            <th scope="col">Ações</th>
                        </tr>
                    </thead>
                    <tfoot class="text-center">
                        <tr>
                            <th>Filme</th>
                            <th>Data Prevista de Devolução</th>
                            <th>Valor</th>
                            <th>Opções</th>
                        </tr>
                    </tfoot>
                    <tbody>
                        {% include 'core/ajax/partial_itens_list.html' %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer small text-muted">Atualizado as 12:54 PM</div>
    </div>


{% endblock conteudo %}
{% block javascript %}
    <script>
        var loadForm = function () {
            var btn = $(this);
            $.ajax({
                url: btn.attr("data-url"),
                type: 'get',
                dataType: 'json',
                beforeSend: function () {
                    $("#genericModal").modal("show");
                },
                success: function (data) {
                    $("#genericModal .modal-content").html(data.html_form);
                    $('.money2').mask("#.##0,00", {reverse: true});
                    $('.date').mask('00/00/0000');
                    $('#id_locacao').val("{{ locacao.pk }}");
                }
            });
        };

        var saveForm = function () {
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                data: form.serialize(),
                type: form.attr("method"),
                dataType: 'json',
                success: function (data) {
                    if (data.form_is_valid) {
                        runNotify({
                            message: 'Item salvo com sucesso!',
                            levelMessage: 'success'
                        });
                        $("#item_locacao_tb tbody").html(data.html_item_list);
                        $("#genericModal").modal("hide");
                    } else {
                        $("#genericModal .modal-content").html(data.html_form);
                    }
                }
            });
            return false;
        };


        var deleteItem = function () {
            var form = $(this);
            $.ajax({
                url: form.attr("action"),
                data: form.serialize(),
                type: form.attr("method"),
                dataType: 'json',
                success: function (data) {
                    if (data.form_is_valid) {
                        runNotify({
                            message: 'Item removido com sucesso!',
                            levelMessage: 'success'
                        });
                        $("#item_locacao_tb tbody").html(data.html_item_list);
                        $("#genericModal").modal("hide");
                    } else {
                        $("#genericModal .modal-content").html(data.html_form);
                    }
                }
            });
            return false;
        };

        // Create item
        $(".js-add-item").click(loadForm);
        $("#genericModal").on("submit", ".js-item-add-form", saveForm);

        // Update item
        $("#item_locacao_tb").on("click", ".js-update-item", loadForm);
        $("#genericModal").on("submit", ".js-item-update-form", saveForm);

        //Delete item
        $("#item_locacao_tb").on("click", ".js-delete-item", loadForm);
        $("#genericModal").on("submit", ".js-item-delete-form", deleteItem);
    </script>
{% endblock javascript %}